- name: build-GoFNOL-image
  plan:
  - get: GoFNOL-dockerfile
    trigger: true
    version: every
  - put: GoFNOL-image
    params:
      build: GoFNOL-dockerfile
      dockerfile: GoFNOL-dockerfile/ci/docker/Dockerfile

- name: build-GoFNOL
  plan:
  - get: GoFNOL-image
    passed:
    - build-GoFNOL-image
  - get: GoFNOL-git
    trigger: true
    version: every
  - task: test-GoFNOL.tests
    image: GoFNOL-image
    config:
      platform: linux
      inputs:
      - name: GoFNOL-git
      run:
        path: bash
        args:
        - -exc
        - |
          export VCAP_SERVICES=$(cat ./GoFNOL-git/ci/cicd_env.json)
          export ASPNETCORE_ENVIRONMENT=Staging
          dotnet test ./GoFNOL-git/GoFNOL.tests/GoFNOL.tests.csproj
  - task: build-GoFNOL
    image: GoFNOL-image
    config:
      platform: linux
      inputs:
      - name: GoFNOL-git
      outputs:
      - name: artifact
      run:
        path: bash
        args:
        - -exc
        - |
          output_directory=${PWD}/artifact
          cd ./GoFNOL-git
          dotnet publish ./GoFNOL/GoFNOL.csproj -c Release -o ${output_directory}/app
          # format the version so that we can use lexicographic search to find the latest
          version=$(git describe | awk -F- '{printf "%s-%04d-%s", $1, $2, $3}')
          filename=GoFNOL-${version}.zip
          cp ./ci/manifest.yml ${output_directory}/manifest.yml
          cd ${output_directory}
          zip -r ${filename} ./*
  - put: GoFNOL-artifactory
    params:
      file: artifact/GoFNOL-*.zip